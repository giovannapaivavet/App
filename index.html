import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    signInWithCustomToken
} from 'firebase/auth';
import {
    getFirestore,
    collection,
    addDoc,
    doc,
    getDoc,
    getDocs,
    setDoc,
    updateDoc,
    deleteDoc,
    onSnapshot,
    query,
    where,
    Timestamp,
    serverTimestamp
} from 'firebase/firestore';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

// Configuração do Firebase
// As variáveis __firebase_config e __app_id são fornecidas pelo ambiente Canvas.
// Se não estiverem definidas, valores padrão são usados para evitar erros em desenvolvimento local.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Inicializa o Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ID da Aplicação (para Firestore)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'controle-financeiro-default';

// Componente de Ícone (SVG simples)
// Reutilizável para vários ícones com base no 'path' do SVG.
const Icon = ({ path, className = "w-6 h-6" }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
        <path strokeLinecap="round" strokeLinejoin="round" d={path} />
    </svg>
);

// Definições de ícones específicos usando o componente Icon
const PlusIcon = () => <Icon path="M12 4.5v15m7.5-7.5h-15" />;
const TrashIcon = () => <Icon path="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />;
const EditIcon = () => <Icon path="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />;
const LogoutIcon = () => <Icon path="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />;

// Novas categorias: Entrada e Saída, com cores associadas
const transactionCategories = [
    { value: "saida", label: "Saída", color: "#FF6384" }, // Vermelho para saídas
    { value: "entrada", label: "Entrada", color: "#4BC0C0" }, // Verde-azulado para entradas
];

// Categorias detalhadas para saídas
const expenseSubcategories = [
    { value: "alimentacao", label: "Alimentação" },
    { value: "aluguel", label: "Aluguel" },
    { value: "cartao", label: "Cartão" },
    { value: "casa", label: "Casa" },
    { value: "estudo", label: "Estudo" },
    { value: "extras", label: "Extras" },
    { value: "funcionarios", label: "Funcionários" },
    { value: "impostos", label: "Impostos" },
    { value: "mesada", label: "Mesada" },
    { value: "pessoal", label: "Pessoal" },
    { value: "saude", label: "Saúde" },
    { value: "prest_cef", label: "Prest. CEF" },
    { value: "carro", label: "Carro" },
];

// Componente Modal Genérico
// Reutilizável para exibir conteúdo em um pop-up.
const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 p-4">
            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                    <button
                        onClick={onClose}
                        className="text-gray-500 hover:text-gray-700 transition-colors p-1 rounded-full hover:bg-gray-200"
                        aria-label="Fechar modal"
                    >
                        <Icon path="M6 18L18 6M6 6l12 12" className="w-5 h-5" />
                    </button>
                </div>
                {children}
            </div>
        </div>
    );
};

// Componente de Notificação
// Exibe mensagens de sucesso ou erro temporariamente.
const Notification = ({ message, type, onClose }) => {
    if (!message) return null;
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    return (
        <div className={`fixed top-5 right-5 ${bgColor} text-white p-4 rounded-md shadow-lg flex items-center z-[100]`}>
            <span>{message}</span>
            <button onClick={onClose} className="ml-4 text-xl font-bold">&times;</button>
        </div>
    );
};

function App() {
    // Estados para gerenciamento de autenticação e dados
    const [user, setUser] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [transactions, setTransactions] = useState([]);
    const [currentView, setCurrentView] = useState('login');
    const [isLoading, setIsLoading] = useState(true);
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Estados para o formulário de transação
    const [description, setDescription] = useState('');
    const [amount, setAmount] = useState('');
    const [category, setCategory] = useState(transactionCategories[0].value); // Default para "Saída"
    const [subcategory, setSubcategory] = useState(''); // Nova subcategoria para saídas
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
    const [dueDate, setDueDate] = useState(''); // Nova data de vencimento
    const [editingTransaction, setEditingTransaction] = useState(null);

    // Estados para modais e notificações
    const [isTransactionModalOpen, setIsTransactionModalOpen] = useState(false);
    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
    const [transactionToDelete, setTransactionToDelete] = useState(null);
    const [notification, setNotification] = useState({ message: '', type: '' });

    // Efeito para gerenciar o estado de autenticação do Firebase
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            setIsLoading(true);
            if (currentUser) {
                setUser(currentUser);
                setUserId(currentUser.uid);
                setCurrentView('dashboard');
            } else {
                try {
                    // Tenta fazer login com token personalizado se disponível, caso contrário, anonimamente
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação inicial:", error);
                    setUser(null);
                    setUserId(null);
                    setCurrentView('login');
                }
            }
            setIsAuthReady(true); // A autenticação está pronta após a tentativa de login
        });
        return () => unsubscribe(); // Limpa o listener ao desmontar o componente
    }, []);

    // Efeito para carregar transações do Firestore em tempo real
    useEffect(() => {
        // Só tenta carregar transações se a autenticação estiver pronta e houver um userId
        if (!isAuthReady || !userId) {
            setTransactions([]);
            setIsLoading(false); // Para o loading se não houver usuário ou auth não estiver pronta
            return;
        }

        setIsLoading(true);
        // Caminho da coleção de transações no Firestore
        const transactionsColPath = `artifacts/${appId}/users/${userId}/expenses`;
        const transactionsCollection = collection(db, transactionsColPath);
        const q = query(transactionsCollection);

        // Listener em tempo real para as transações
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const transactionsData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Converte Timestamp do Firestore para string de data para exibição
                date: doc.data().date instanceof Timestamp ? doc.data().date.toDate().toISOString().split('T')[0] : doc.data().date,
                dueDate: doc.data().dueDate instanceof Timestamp ? doc.data().dueDate.toDate().toISOString().split('T')[0] : doc.data().dueDate
            }));
            // Ordena as transações pela data mais recente primeiro
            transactionsData.sort((a, b) => new Date(b.date) - new Date(a.date));
            setTransactions(transactionsData);
            setIsLoading(false); // Finaliza o loading após carregar os dados
        }, (error) => {
            console.error("Erro ao buscar transações:", error);
            showNotification(`Erro ao buscar transações: ${error.message}`, 'error');
            setIsLoading(false);
        });

        return () => unsubscribe(); // Limpa o listener ao desmontar ou quando userId/isAuthReady mudam
    }, [isAuthReady, userId]);

    // Função para exibir notificações
    const showNotification = (message, type) => {
        setNotification({ message, type });
        setTimeout(() => {
            setNotification({ message: '', type: '' });
        }, 3000); // Notificação desaparece após 3 segundos
    };

    // Funções de Autenticação
    const handleRegister = async (email, password) => {
        setIsSubmitting(true);
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showNotification('Usuário registrado com sucesso!', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
        setIsSubmitting(false);
    };

    const handleLogin = async (email, password) => {
        setIsSubmitting(true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showNotification('Login realizado com sucesso!', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
        setIsSubmitting(false);
    };

    const handleLogout = async () => {
        setIsSubmitting(true);
        try {
            await signOut(auth);
            setUser(null);
            setUserId(null);
            setTransactions([]);
            setCurrentView('login');
            showNotification('Logout realizado com sucesso!', 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        }
        setIsSubmitting(false);
    };

    // Funções CRUD para Transações
    const handleAddOrUpdateTransaction = async (e) => {
        e.preventDefault();
        // Validação de campos obrigatórios
        if (!description || !amount || !category || !date) {
            showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
            return;
        }
        if (parseFloat(amount) <= 0) {
            showNotification('O valor da transação deve ser positivo.', 'error');
            return;
        }
        // Validação para subcategoria de saída
        if (category === 'saida' && !subcategory) {
            showNotification('Por favor, selecione uma subcategoria para a saída.', 'error');
            return;
        }
        // Validação para data de vencimento de saída
        if (category === 'saida' && !dueDate) {
            showNotification('Por favor, insira a data de vencimento para a saída.', 'error');
            return;
        }

        setIsSubmitting(true);
        const transactionData = {
            description,
            amount: parseFloat(amount),
            category, // "entrada" ou "saida"
            date,
            // Adiciona subcategoria e data de vencimento apenas se for uma saída
            ...(category === 'saida' && { subcategory, dueDate }),
            updatedAt: serverTimestamp() // Atualiza o timestamp de modificação
        };

        try {
            const transactionsColPath = `artifacts/${appId}/users/${userId}/expenses`;
            if (editingTransaction) {
                // Atualiza uma transação existente
                const transactionDocRef = doc(db, transactionsColPath, editingTransaction.id);
                await updateDoc(transactionDocRef, transactionData);
                showNotification('Transação atualizada com sucesso!', 'success');
            } else {
                // Adiciona uma nova transação
                await addDoc(collection(db, transactionsColPath), {
                    ...transactionData,
                    createdAt: serverTimestamp() // Adiciona o timestamp de criação
                });
                showNotification('Transação adicionada com sucesso!', 'success');
            }
            closeTransactionModal(); // Fecha o modal após a operação
        } catch (error) {
            showNotification(`Erro ao salvar transação: ${error.message}`, 'error');
        }
        setIsSubmitting(false);
    };

    const handleDeleteTransaction = async () => {
        if (!transactionToDelete) return;
        setIsSubmitting(true);
        try {
            const transactionsColPath = `artifacts/${appId}/users/${userId}/expenses`;
            const transactionDocRef = doc(db, transactionsColPath, transactionToDelete.id);
            await deleteDoc(transactionDocRef);
            showNotification('Transação excluída com sucesso!', 'success');
            closeDeleteModal();
        } catch (error) {
            showNotification(`Erro ao excluir transação: ${error.message}`, 'error');
        }
        setIsSubmitting(false);
    };

    // Funções para abrir e fechar modais
    const openTransactionModal = (transaction = null) => {
        if (transaction) {
            // Preenche o formulário com os dados da transação para edição
            setEditingTransaction(transaction);
            setDescription(transaction.description);
            setAmount(transaction.amount.toString());
            setCategory(transaction.category);
            setDate(transaction.date);
            setSubcategory(transaction.subcategory || ''); // Define a subcategoria se existir
            setDueDate(transaction.dueDate || ''); // Define a data de vencimento se existir
        } else {
            // Reseta o formulário para adicionar uma nova transação
            setEditingTransaction(null);
            setDescription('');
            setAmount('');
            setCategory(transactionCategories[0].value); // Default "Saída"
            setSubcategory('');
            setDate(new Date().toISOString().split('T')[0]);
            setDueDate('');
        }
        setIsTransactionModalOpen(true);
    };

    const closeTransactionModal = () => {
        setIsTransactionModalOpen(false);
        setEditingTransaction(null);
    };

    const openDeleteModal = (transaction) => {
        setTransactionToDelete(transaction);
        setIsDeleteModalOpen(true);
    };

    const closeDeleteModal = () => {
        setTransactionToDelete(null);
        setIsDeleteModalOpen(false);
    };

    // Componente AuthForm para login e registro
    const AuthForm = ({ type, onSubmit }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const handleSubmit = (e) => { e.preventDefault(); onSubmit(email, password); };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-500 to-teal-500 p-4">
                <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                    <h2 className="text-3xl font-bold text-center text-gray-800 mb-8">
                        {type === 'login' ? 'Aceder ao Controlo Financeiro' : 'Criar Conta'}
                    </h2>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="o_seu@email.com" />
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-gray-700">Palavra-passe</label>
                            <input type="password" id="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="********" />
                        </div>
                        <button type="submit" disabled={isSubmitting} className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50">
                            {isSubmitting ? 'A processar...' : (type === 'login' ? 'Entrar' : 'Criar Conta')}
                        </button>
                    </form>
                    <p className="mt-6 text-center text-sm text-gray-600">
                        {type === 'login' ? "Não tem uma conta? " : "Já tem uma conta? "}
                        <button onClick={() => setCurrentView(type === 'login' ? 'register' : 'login')} className="font-medium text-teal-600 hover:text-teal-500">
                            {type === 'login' ? 'Registe-se' : 'Faça login'}
                        </button>
                    </p>
                     {userId && <p className="mt-4 text-xs text-center text-gray-500 break-all">ID do Utilizador (Sessão): {userId}</p>}
                </div>
            </div>
        );
    };

    // Componente DashboardView para exibir o painel de controle financeiro
    const DashboardView = () => {
        // Calcula o saldo total
        const balance = transactions.reduce((acc, transaction) => {
            if (transaction.category === 'entrada') {
                return acc + transaction.amount;
            } else if (transaction.category === 'saida') {
                return acc - transaction.amount;
            }
            return acc;
        }, 0);

        // Calcula os totais de entradas e saídas
        const totalEntradas = transactions.filter(t => t.category === 'entrada').reduce((sum, t) => sum + t.amount, 0);
        const totalSaidas = transactions.filter(t => t.category === 'saida').reduce((sum, t) => sum + t.amount, 0);

        // Dados para o gráfico de pizza (Entradas vs Saídas)
        const chartData = [
            { name: 'Entradas', value: totalEntradas, color: transactionCategories.find(c=>c.value === 'entrada').color },
            { name: 'Saídas', value: totalSaidas, color: transactionCategories.find(c=>c.value === 'saida').color },
        ].filter(d => d.value > 0); // Só mostra no gráfico se houver valor

        // Transações ordenadas (já feito no useEffect, mas aqui para garantir)
        const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

        return (
            <div className="min-h-screen bg-gray-100 p-4 md:p-8">
                <header className="mb-8">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center py-6 bg-white shadow-md rounded-lg">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">O Meu Controlo Financeiro</h1>
                            {user && user.email && <p className="text-sm text-gray-600">Sessão iniciada como: {user.email}</p>}
                            {userId && <p className="text-xs text-gray-500 break-all">ID do Utilizador: {userId}</p>}
                        </div>
                        <div className="flex items-center space-x-3 mt-4 sm:mt-0">
                            <button onClick={() => openTransactionModal()} className="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center space-x-2">
                                <PlusIcon />
                                <span>Adicionar Transação</span>
                            </button>
                            <button onClick={handleLogout} disabled={isSubmitting} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center space-x-2 disabled:opacity-50">
                                <LogoutIcon />
                                <span>Sair</span>
                            </button>
                        </div>
                    </div>
                </header>

                {isLoading && !transactions.length && !isAuthReady ? (
                    // Exibe um spinner de carregamento enquanto os dados são buscados
                    <div className="flex justify-center items-center h-64">
                        <svg className="animate-spin h-10 w-10 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p className="ml-3 text-gray-600 text-lg">A carregar transações...</p>
                    </div>
                ) : (
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <section className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h2 className="text-xl font-semibold text-gray-700 mb-2">Saldo Atual</h2>
                                <p className={`text-3xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    R$ {balance.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </p>
                                <div className="mt-4 space-y-1 text-sm">
                                    <p className="text-green-500">Total de Entradas: R$ {totalEntradas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                                    <p className="text-red-500">Total de Saídas: R$ {totalSaidas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                                </div>
                            </div>
                            {transactions.length > 0 && chartData.length > 0 && (
                                <div className="bg-white p-6 rounded-xl shadow-lg">
                                    <h2 className="text-xl font-semibold text-gray-700 mb-4">Distribuição (Entradas vs Saídas)</h2>
                                    <div style={{ width: '100%', height: 300 }}>
                                        <ResponsiveContainer>
                                            <PieChart>
                                                <Pie data={chartData} cx="50%" cy="50%" labelLine={false} outerRadius={80} fill="#8884d8" dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                                    {chartData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                                    ))}
                                                </Pie>
                                                <Tooltip formatter={(value) => `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`} />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            )}
                        </section>

                        <section className="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h2 className="text-xl font-semibold text-gray-700 mb-6">Histórico de Transações</h2>
                            {sortedTransactions.length === 0 && !isLoading ? (
                                // Mensagem exibida quando não há transações
                                <div className="text-center py-10">
                                    <Icon path="M21.75 17.25v-.228a4.5 4.5 0 00-.12-1.03l-2.268-9.64a3.375 3.375 0 00-3.285-2.602H7.923a3.375 3.375 0 00-3.285 2.602l-2.268 9.64a4.5 4.5 0 00-.12 1.03v.228m19.5 0a3 3 0 01-3 3H5.25a3 3 0 01-3-3m19.5 0a3 3 0 00-3-3H5.25a3 3 0 00-3 3m16.5 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008z" className="mx-auto h-12 w-12 text-gray-400"/>
                                    <h3 className="mt-2 text-lg font-medium text-gray-900">Nenhuma transação registada</h3>
                                    <p className="mt-1 text-sm text-gray-500">Comece por adicionar a sua primeira entrada ou saída.</p>
                                    <button type="button" onClick={() => openTransactionModal()} className="mt-6 inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700">
                                        <PlusIcon /> Adicionar Transação
                                    </button>
                                </div>
                            ) : (
                                // Lista de transações
                                <ul className="space-y-4">
                                    {sortedTransactions.map(transaction => {
                                        const categoryDetails = transactionCategories.find(c => c.value === transaction.category) || { label: 'Desconhecido', color: '#C9CBCF' };
                                        const isEntrada = transaction.category === 'entrada';
                                        const subcategoryLabel = expenseSubcategories.find(sub => sub.value === transaction.subcategory)?.label || '';
                                        return (
                                            <li key={transaction.id} className="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow bg-gray-50">
                                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                                    <div className="flex-1 mb-2 sm:mb-0">
                                                        <div className="flex items-center">
                                                            <span className="inline-block h-3 w-3 rounded-full mr-2" style={{ backgroundColor: categoryDetails.color }}></span>
                                                            <h3 className="text-lg font-medium text-gray-800">{transaction.description}</h3>
                                                        </div>
                                                        <p className="text-sm text-gray-500">
                                                            {categoryDetails.label}
                                                            {subcategoryLabel && ` (${subcategoryLabel})`}
                                                            {' - '}
                                                            {new Date(transaction.date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                                            {transaction.dueDate && ` (Vencimento: ${new Date(transaction.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')})`}
                                                        </p>
                                                    </div>
                                                    <div className="flex items-center space-x-3 w-full sm:w-auto justify-end">
                                                        <p className={`text-lg font-semibold whitespace-nowrap ${isEntrada ? 'text-green-600' : 'text-red-500'}`}>
                                                            {isEntrada ? '+' : '-'} R$ {transaction.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                        </p>
                                                        <button onClick={() => openTransactionModal(transaction)} className="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-full" title="Editar Transação">
                                                            <EditIcon className="w-5 h-5" />
                                                        </button>
                                                        <button onClick={() => openDeleteModal(transaction)} className="p-2 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full" title="Excluir Transação">
                                                            <TrashIcon className="w-5 h-5" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </li>
                                        );
                                    })}
                                </ul>
                            )}
                        </section>
                    </main>
                )}

                {/* Modal para Adicionar/Editar Transação */}
                <Modal isOpen={isTransactionModalOpen} onClose={closeTransactionModal} title={editingTransaction ? 'Editar Transação' : 'Adicionar Nova Transação'}>
                    <form onSubmit={handleAddOrUpdateTransaction} className="space-y-4">
                        <div>
                            <label htmlFor="description" className="block text-sm font-medium text-gray-700">Descrição</label>
                            <input type="text" id="description" value={description} onChange={(e) => setDescription(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Ex: Salário, Aluguel"/>
                        </div>
                        <div>
                            <label htmlFor="amount" className="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="number" id="amount" value={amount} onChange={(e) => setAmount(e.target.value)} required step="0.01" min="0.01" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Ex: 1500.00"/>
                        </div>
                        <div>
                            <label htmlFor="category" className="block text-sm font-medium text-gray-700">Tipo de Transação</label>
                            <select id="category" value={category} onChange={(e) => { setCategory(e.target.value); setSubcategory(''); setDueDate(''); }} required className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                {transactionCategories.map(cat => (
                                    <option key={cat.value} value={cat.value}>{cat.label}</option>
                                ))}
                            </select>
                        </div>
                        {category === 'saida' && (
                            <>
                                <div>
                                    <label htmlFor="subcategory" className="block text-sm font-medium text-gray-700">Subcategoria (Saída)</label>
                                    <select id="subcategory" value={subcategory} onChange={(e) => setSubcategory(e.target.value)} required={category === 'saida'} className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                        <option value="">Selecione uma subcategoria</option>
                                        {expenseSubcategories.map(subcat => (
                                            <option key={subcat.value} value={subcat.value}>{subcat.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="dueDate" className="block text-sm font-medium text-gray-700">Data de Vencimento</label>
                                    <input type="date" id="dueDate" value={dueDate} onChange={(e) => setDueDate(e.target.value)} required={category === 'saida'} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"/>
                                </div>
                            </>
                        )}
                        <div>
                            <label htmlFor="date" className="block text-sm font-medium text-gray-700">Data da Transação</label>
                            <input type="date" id="date" value={date} onChange={(e) => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"/>
                        </div>
                        <div className="flex justify-end space-x-3 pt-2">
                            <button type="button" onClick={closeTransactionModal} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md border">Cancelar</button>
                            <button type="submit" disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 rounded-md shadow-sm disabled:opacity-50 flex items-center">
                                {isSubmitting ? 'A guardar...' : (editingTransaction ? 'Guardar Alterações' : 'Adicionar Transação')}
                            </button>
                        </div>
                    </form>
                </Modal>

                {/* Modal de Confirmação de Exclusão */}
                <Modal isOpen={isDeleteModalOpen} onClose={closeDeleteModal} title="Confirmar Exclusão">
                    <p className="text-gray-700 mb-6">Tem certeza de que deseja excluir esta transação? Esta ação não pode ser desfeita.</p>
                    <div className="flex justify-end space-x-3">
                        <button type="button" onClick={closeDeleteModal} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md border">Cancelar</button>
                        <button type="button" onClick={handleDeleteTransaction} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md shadow-sm disabled:opacity-50 flex items-center">
                            {isSubmitting ? 'A excluir...' : 'Excluir'}
                        </button>
                    </div>
                </Modal>

                {/* Componente de Notificação */}
                <Notification message={notification.message} type={notification.type} onClose={() => setNotification({ message: '', type: '' })} />
            </div>
        );
    };

    // Tela de loading inicial enquanto a autenticação está a ser verificada
    if (isLoading && !isAuthReady) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
                <svg className="animate-spin h-12 w-12 text-teal-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p className="text-gray-700 text-xl">A carregar aplicação...</p>
            </div>
        );
    }

    // Renderiza o componente principal com base no estado de autenticação
    return (
        <div className="App">
            {user ? (
                <DashboardView /> // Se o utilizador estiver autenticado, mostra o dashboard
            ) : (
                // Caso contrário, mostra o formulário de login ou registo
                currentView === 'login' ? (
                    <AuthForm type="login" onSubmit={handleLogin} />
                ) : (
                    <AuthForm type="register" onSubmit={handleRegister} />
                )
            )}
        </div>
    );
}

export default App;
